<%# path: database/migrations %>
import type { Knex } from "knex";
import { ETableNames } from "../ETableNames";

export async function up(knex: Knex) {
  return await knex.schema.createTable(
    ETableNames.<%= entityName.toLowerCase() %>,
    (table) => {

      table.bigIncrements("id").primary().index();

      <% properties.forEach(prop => { %>
        <% if (prop.field !== "id") { %>
          <% if (prop.type === "string") { %>
            table.string("<%= prop.field %>", 255)
              .checkLength("<=", 255)
              .index()
              <%= prop.isOptional ? "" : ".notNullable()" %>;
          <% } else if (prop.type === "number") { %>
            table.integer("<%= prop.field %>")
              .index()
              <%= prop.isOptional ? "" : ".notNullable()" %>;
          <% } else if (prop.type === "boolean") { %>
            table.boolean("<%= prop.field %>")
              <%= prop.isOptional ? "" : ".notNullable()" %>;
          <% } else { %>
            table.string("<%= prop.field %>").index();
          <% } %>
        <% } %>
      <% }) %>

      <% /* relations: generate FK for belongsTo relations */ %>
      <% if (relations && relations.length > 0) { %>
        <% relations.forEach(rel => { %>
          <% if (rel.type === "belongsTo") { %>
            // Relation: belongsTo <%= rel.target %>
            table.bigInteger("<%= rel.field %>")
              .unsigned()
              .index()
              <%= rel.isOptional ? "" : ".notNullable()" %>;

            table
              .foreign("<%= rel.field %>")
              .references("id")
              .inTable(ETableNames.<%= rel.target.toLowerCase() %>)
              .onDelete("CASCADE");
          <% } %>
        <% }) %>
      <% } %>

      table.comment("Tabela gerada automaticamente para a entidade <%= entityName %>.");
    }
  );

  console.log(`# ✅ Created table ${ETableNames.<%= entityName.toLowerCase() %>}`);
}

export async function down(knex: Knex) {
  console.log(`# ⛔ Dropped table ${ETableNames.<%= entityName.toLowerCase() %>}`);
  return await knex.schema.dropTable(ETableNames.<%= entityName.toLowerCase() %>);
}
