<%# path: database/migrations %>
import type { Knex } from "knex";
import { ETableNames } from "../ETableNames";

export async function up(knex: Knex) {
  return await knex.schema.createTable(
    ETableNames.<%= entityName.toLowerCase() %>,
    (table) => {

      table.bigIncrements("id").primary().index();

      <% /* =====================
           RELATION FIELDS (FKs)
           ===================== */ %>
      <%
        const relationFields = (relations || []).map(r => r.field);
      %>

      <% /* =====================
           PROPERTIES
           ===================== */ %>
      <% properties.forEach(prop => { %>
        <% if (prop.field !== "id" && !relationFields.includes(prop.field)) { %>

          <% if (prop.type === "string") { %>
            table.string("<%= prop.field %>", 255)
              .checkLength("<=", 255)
              .index()
              <%= prop.isOptional ? "" : ".notNullable()" %>;
          <% } else if (prop.type === "number") { %>
            table.integer("<%= prop.field %>")
              .index()
              <%= prop.isOptional ? "" : ".notNullable()" %>;
          <% } else if (prop.type === "boolean") { %>
            table.boolean("<%= prop.field %>")
              <%= prop.isOptional ? "" : ".notNullable()" %>;
          <% } else { %>
            table.string("<%= prop.field %>").index();
          <% } %>

        <% } %>
      <% }) %>

      <% /* =====================
           RELATIONS
           ===================== */ %>
      <% if (relations && relations.length > 0) { %>
        <% relations.forEach(rel => { %>

          <% /* -------- belongsTo (N:1) -------- */ %>
          <% if (rel.type === "belongsTo") { %>
            // Relation: belongsTo <%= rel.target %>
            table.bigInteger("<%= rel.field %>")
              .unsigned()
              .index()
              <%= rel.isOptional ? "" : ".notNullable()" %>;

            table
              .foreign("<%= rel.field %>")
              .references("id")
              .inTable(ETableNames.<%= rel.target.toLowerCase() %>)
              .onDelete("<%= rel.onDelete || "CASCADE" %>");
          <% } %>

          <% /* -------- hasOne (1:1) -------- */ %>
          <% if (rel.type === "hasOne") { %>
            // Relation: hasOne <%= rel.target %>
            table.bigInteger("<%= rel.field %>")
              .unsigned()
              .unique()
              .index()
              <%= rel.isOptional ? "" : ".notNullable()" %>;

            table
              .foreign("<%= rel.field %>")
              .references("id")
              .inTable(ETableNames.<%= rel.target.toLowerCase() %>)
              .onDelete("<%= rel.onDelete || "CASCADE" %>");
          <% } %>

          <% /* -------- hasMany (1:N) -------- */ %>
          <% if (rel.type === "hasMany") { %>
            // Relation: hasMany <%= rel.target %>
            // FK será criada na tabela <%= rel.target %>
          <% } %>

          <% /* -------- manyToMany (N:N) -------- */ %>
          <% if (rel.type === "manyToMany") { %>
            // Relation: manyToMany <%= rel.target %>
            // Pivot table: <%= entityName.toLowerCase() %>_<%= rel.target.toLowerCase() %>
            // Pivot table será criada em outra migration
          <% } %>

          <% /* -------- self relation -------- */ %>
          <% if (rel.type === "self") { %>
            // Relation: self (auto-relacionamento)
            table.bigInteger("<%= rel.field %>")
              .unsigned()
              .index()
              <%= rel.isOptional ? "" : ".notNullable()" %>;

            table
              .foreign("<%= rel.field %>")
              .references("id")
              .inTable(ETableNames.<%= entityName.toLowerCase() %>)
              .onDelete("<%= rel.onDelete || "SET NULL" %>");
          <% } %>

        <% }) %>
      <% } %>

      table.comment(
        "Table automatically generated for the entity <%= entityName %>."
      );
    }
  );

  console.log(`# ✅ Created table ${ETableNames.<%= entityName.toLowerCase() %>}`);
}

export async function down(knex: Knex) {
  console.log(`# ⛔ Dropped table ${ETableNames.<%= entityName.toLowerCase() %>}`);
  return await knex.schema.dropTable(
    ETableNames.<%= entityName.toLowerCase() %>
  );
}
