<%# path: database/provider %>
import { ETableNames } from "../../database/ETableNames";
import { Knex } from "../../database/knex";
import { <%= entityName %> } from "../../entities/<%= entityName %>.entity";

export class <%= entityName %>Provider {

  private searchableFields = <%- JSON.stringify(searchableFields) %>;

  private applySearch(query: any, filter: string) {
    if (!filter || this.searchableFields.length === 0) return query;

    return query.where((qb: any) => {
      this.searchableFields.forEach((field, index) => {
        if (index === 0) {
          qb.where(field, "like", `%${filter}%`);
        } else {
          qb.orWhere(field, "like", `%${filter}%`);
        }
      });
    });
  }

  async count(filter = ""): Promise<number | Error> {
    try {
      let query = Knex(ETableNames.<%= entityName.toLowerCase() %>).count<{ count: number }>({ count: "*" });

      query = this.applySearch(query, filter);

      const [{ count }] = await query;

      return Number(count);
    } catch (error) {
      console.error(error);
      return new Error("Erro ao consultar a quantidade total de registros");
    }
  }

  async create(data: Omit<<%= entityName %>, "id">): Promise<number | Error> {
    try {
      const [result] = await Knex(ETableNames.<%= entityName.toLowerCase() %>)
        .insert(data)
        .returning("id");

      if (typeof result === "object") return result.id;
      if (typeof result === "number") return result;

      return new Error("Erro ao cadastrar o registro");
    } catch (error) {
      console.error(error);
      return new Error("Erro ao cadastrar o registro");
    }
  }

  async getAll(
    page: number,
    limit: number,
    filter: string,
    id = 0
  ): Promise<<%= entityName %>[] | Error> {
    try {
      let query = Knex(ETableNames.<%= entityName.toLowerCase() %>).select("*");

      if (id > 0) {
        query = query.where("id", id);
      }

      query = this.applySearch(query, filter)
        .offset((page - 1) * limit)
        .limit(limit);

      const result = await query;

      if (id > 0 && result.every(item => item.id !== id)) {
        const resultById = await Knex(ETableNames.<%= entityName.toLowerCase() %>)
          .select("*")
          .where("id", id)
          .first();

        if (resultById) return [...result, resultById];
      }

      return result;
    } catch (error) {
      console.error(error);
      return new Error("Erro ao consultar registros");
    }
  }

  async getById(id: number): Promise<<%= entityName %> | Error> {
    try {
      const result = await Knex(ETableNames.<%= entityName.toLowerCase() %>)
        .select("*")
        .where("id", id)
        .first();

      return result || new Error("Registro n√£o encontrado");
    } catch (error) {
      console.error(error);
      return new Error("Erro ao buscar registro");
    }
  }

  async updateById(
    id: number,
    data: Omit<<%= entityName %>, "id">
  ): Promise<void | Error> {
    try {
      const result = await Knex(ETableNames.<%= entityName.toLowerCase() %>)
        .update(data)
        .where("id", id);

      if (result > 0) return;

      return new Error("Erro ao atualizar registro");
    } catch (error) {
      console.error(error);
      return new Error("Erro ao atualizar registro");
    }
  }

  async deleteById(id: number): Promise<void | Error> {
    try {
      const result = await Knex(ETableNames.<%= entityName.toLowerCase() %>)
        .delete()
        .where("id", id);

      if (result > 0) return;

      return new Error("Erro ao deletar registro");
    } catch (error) {
      console.error(error);
      return new Error("Erro ao deletar registro");
    }
  }
}
